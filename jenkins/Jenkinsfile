pipeline {
agent {
      label 'nodejs8'
  }
stages
  {
  stage ('install modules'){
   steps {
    sh '''
      npm install --verbose -d 
      npm install --save classlist.js
    '''
  }
 }
  stage ('Build App') {
  steps {
    sh '$(npm bin)/ng build --prod --build-optimizer'
    sh 'cp nginx/status.conf dist/nginx-cfg'
  }
 }
  
    stage('Create Image Builder') {
      when {
        expression {
          openshift.withCluster() {
            return !openshift.selector("bc", "saimaster").exists();
          }
        }
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.newBuild("--name=saimaster", "--image-stream=registry.access.redhat.com/rhscl/nginx-112-rhel7", "--binary")
          }
        }
      }
    }
    stage('Build Image') {
      steps {
        script {
          openshift.withCluster() {
            openshift.selector("bc", "saimaster").startBuild("--from-dir=dist", "--wait")
          }
        }
      }
    }
    stage('Promote to DEV') {
      steps {
        script {
          openshift.withCluster() {
            openshift.tag("saimaster:latest", "saimaster:dev")
          }
        }
      }
    }
    stage('Create DEV') {
      when {
        expression {
          openshift.withCluster() {
            return !openshift.selector('dc', 'saimaster-dev').exists()
          }
        }
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.newApp("saimaster:latest", "--name=saimaster-dev").narrow('svc').expose()
          }
        }
      }
    }
    stage('Promote STAGE') {
      steps {
        script {
          openshift.withCluster() {
            openshift.tag("saimaster:dev", "saimaster:stage")
          }
        }
      }
    }
    stage('Create STAGE') {
      when {
        expression {
          openshift.withCluster() {
            return !openshift.selector('dc', 'saimaster-stage').exists()
          }
        }
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.newApp("saimaster:stage", "--name=saimaster-stage").narrow('svc').expose()
          }
        }
      }
    }
  }
}
